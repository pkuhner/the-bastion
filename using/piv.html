

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PIV keys &mdash; The Bastion 3.01.99-rc2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/thebastion.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Bastion 3.01.99-rc2 documentation" href="../index.html"/>
        <link rel="up" title="Using the bastion" href="index.html"/>
        <link rel="next" title="Administration" href="../administration/index.html"/>
        <link rel="prev" title="The basics" href="basics.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Bastion
          

          
          </a>

          
            
            
              <div class="version">
                3.01.99-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../presentation/index.html">Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation &amp; Setup</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Using the bastion</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basics.html">The basics</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">PIV keys</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#without-a-policy">Without a policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#per-account-policy">Per-account policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#global-policy">Global policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#temporary-grace-period">Temporary grace period</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../administration/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Bastion plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Bastion</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Using the bastion</a> &raquo;</li>
        
      <li>PIV keys</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/using/piv.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="piv-keys">
<h1><a class="toc-backref" href="#id1">PIV keys</a><a class="headerlink" href="#piv-keys" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#piv-keys" id="id1">PIV keys</a><ul>
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#without-a-policy" id="id3">Without a policy</a></li>
<li><a class="reference internal" href="#per-account-policy" id="id4">Per-account policy</a></li>
<li><a class="reference internal" href="#global-policy" id="id5">Global policy</a></li>
<li><a class="reference internal" href="#temporary-grace-period" id="id6">Temporary grace period</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The Bastion supports enabling a policy forcing accounts SSH ingress keys to originate from a known hardware token, ensuring that the private SSH key is only stored on this hardware token, and not on the filesystem.</p>
<p>Currently, only Yubico keys implementing PIV can be verified this way. In that case, each individual hardware token has a builtin Certificate Authority, signed by a well-known Yubico certificate, hence proving that the hardware token is known and legit. This builtin CA, in turn, emits an attestation certificate each time a new PIV key is generated on the hardware token, hence proving that the bikey (private and public) has been generated by this individual hardware token. Other metadata is included in the attestation, such as the firmware version, the serial number of the token, the <em>TouchPolicy</em> and <em>PinPolicy</em>. Note that you may decide to overwrite the builtin CA by a one of your own, possibly signed by a CA of your company. This would ensure not only that the SSH key is provided by the device, but also that the device has been provided by your company. Please refer to the <a class="reference external" href="https://developers.yubico.com/PIV/Introduction/PIV_attestation.html">Yubico PIV attestation page</a> and the <a class="reference external" href="https://developers.yubico.com/yubico-piv-tool/YubiKey_PIV_introduction.html">Yubico PIV tool page</a> for more information.</p>
</div>
<div class="section" id="without-a-policy">
<h2><a class="toc-backref" href="#id3">Without a policy</a><a class="headerlink" href="#without-a-policy" title="Permalink to this headline">¶</a></h2>
<p>If you want to support PIV keys without making those mandatory, you don't have anything to do: those keys are just regular RSA/ECDSA keys and they <em>just work</em> with The Bastion.
In that case, after having properly configured your hardware token with a key in slot 9a, you can just use <a class="reference internal" href="../plugins/open/selfAddIngressKey.html"><span class="doc">selfAddIngressKey</span></a> to add the key to your bastion account, and call it a day. As a quick guidance, on a Yubikey you can usually generate a key in the proper slot this way, after you've setup a management key:</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span><span class="n">yubico</span><span class="o">-</span><span class="n">piv</span><span class="o">-</span><span class="n">tool</span> <span class="o">--</span><span class="n">key</span><span class="o">=</span><span class="n">YOUR_MGMT_KEY</span> <span class="o">--</span><span class="n">action</span> <span class="n">generate</span> <span class="o">--</span><span class="n">pin</span><span class="o">-</span><span class="n">policy</span> <span class="n">always</span> <span class="o">--</span><span class="n">touch</span><span class="o">-</span><span class="n">policy</span> <span class="n">never</span> <span class="o">--</span><span class="n">slot</span> <span class="mi">9</span><span class="n">a</span> <span class="o">-</span><span class="n">o</span> <span class="o">-</span>
</pre></div>
</div>
<p>Now, if you want the bastion to be aware that this key is from a hardware token, you shall use the <code class="docutils literal"><span class="pre">--piv</span></code> option to <a class="reference internal" href="../plugins/open/selfAddIngressKey.html"><span class="doc">selfAddIngressKey</span></a>. This won't do anything special per-se, except storing the certificates information, and showing the details of the PIV key in command outputs such as <a class="reference internal" href="../plugins/open/selfListIngressKeys.html"><span class="doc">selfListIngressKeys</span></a>. Note however that if in the future you enable the PIV enforcing policy either on your account or globally, this key will be considered valid, contrary to all the keys added without the <code class="docutils literal"><span class="pre">--piv</span></code> option, even if these keys happen to be PIV ones. To add a key with the <code class="docutils literal"><span class="pre">--piv</span></code> option, you'll need the SSH public key as usual, but also the attestation certificate and the key certificate. Step by step details on how to get those are out of the scope of this document, but again as a quick guidance, on a Yubikey you can usually get those this way:</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span><span class="n">yubico</span><span class="o">-</span><span class="n">piv</span><span class="o">-</span><span class="n">tool</span> <span class="o">--</span><span class="n">action</span><span class="o">=</span><span class="n">read</span><span class="o">-</span><span class="n">certificate</span> <span class="o">--</span><span class="n">slot</span><span class="o">=</span><span class="mi">9</span><span class="n">a</span> <span class="o">--</span><span class="n">key</span><span class="o">-</span><span class="nb">format</span><span class="o">=</span><span class="n">SSH</span>
<span class="n">yubico</span><span class="o">-</span><span class="n">piv</span><span class="o">-</span><span class="n">tool</span> <span class="o">--</span><span class="n">action</span><span class="o">=</span><span class="n">attest</span> <span class="o">--</span><span class="n">slot</span><span class="o">=</span><span class="mi">9</span><span class="n">a</span>
<span class="n">yubico</span><span class="o">-</span><span class="n">piv</span><span class="o">-</span><span class="n">tool</span> <span class="o">--</span><span class="n">action</span><span class="o">=</span><span class="n">read</span><span class="o">-</span><span class="n">certificate</span> <span class="o">--</span><span class="n">slot</span><span class="o">=</span><span class="n">f9</span>
</pre></div>
</div>
<p>When you'll have added your key, you'll see a few more details than usual:</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>$ bssh --osh selfAddIngressKey --piv
Enter PIN for &#39;PIV Card Holder pin (PIV_II)&#39;:
---the-bastion.example.org--------------------------------the-bastion-3.01.03---
=&gt; add a new public key to your account
--------------------------------------------------------------------------------
~ Please paste the SSH key you want to add. This bastion supports the following algorithms:
~ ED25519: strongness[#####] speed[#####], use `ssh-keygen -t ed25519&#39; to generate one
~ ECDSA  : strongness[####.] speed[#####], use `ssh-keygen -t ecdsa -b 521&#39; to generate one
~ RSA    : strongness[###..] speed[#....], use `ssh-keygen -t rsa -b 4096&#39; to generate one
~
~ In any case, don&#39;t save it without a passphrase.
~ You can prepend your key with a from=&quot;IP1,IP2,...&quot; as this bastion policy allows ingress keys &quot;from&quot; override by users
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyAMtxGT/RvzBZXiYlrCswZMruRtoBtONrVJTZ3Cj5ZpjaZyCRjQ/ETzZXXbvu9KiBsZyhVb/5H9F7CSGi+D5BlcRAKrT9P8MsT7BHWU14GhJddhHDy4rMnXapE93oxbnQIjQT34ozvTKlb0qOoR/SlT14LllvQS6ajaXB7Fm4bAJG/gYGXHEs2nmZn37Rll6vvpZ4ExM29UrqU3hAjYO0Ha+kL5G8Tr+fOhV/5ZmzNsYigdW7Ft7Co4Tpld9D0PqVhDPK7F1zHIFUXunFsewGtB3IQxLdLGDaCMzrRi11V6q/pBzN/75YsW6npRdOzJKjnwxG19lTtVCmCY3EPRFz
~
~ You have requested to add a PIV-enabled SSH key.
~ Please paste the PIV attestation certificate of your hardware key in PEM format.
~ This snippet should start with &#39;-----BEGIN CERTIFICATE-----&#39; and end with &#39;-----END CERTIFICATE-----&#39;:
~
-----BEGIN CERTIFICATE-----
MIIDIDCCAgigAwIBAgIQAajpKeFbM+X1Yfk8GaH9dzANBgkqhkiG9w0BAQsFADAh
MR8wHQYDVQQDDBZZdWJpY28gUElWIEF0dGVzdGF0aW9uMCAXDTE2MDMxNDAwMDAw
MFoYDzIwNTIwNDE3MDAwMDAwWjAlMSMwIQYDVQQDDBpZdWJpS2V5IFBJViBBdHRl
c3RhdGlvbiA5YTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALIAy3EZ
P9G/MFleJiWsKzBkyu5G2gG042tUlNncKPlmmNpnIJGND8RPNlddu+70qIGxnKFV
v/kf0XsJIaL4PkGVxEAqtP0/wyxPsEdZTXgaEl12EcPLisyddqkT3ejFudAiNBPf
ijO9MqVvSo6hH9KVPXguWW9BLpqNpcHsWbhsAkb+BgZccSzaeZmfftGWXq++lngT
Ezb1SupTeECNg7Qdr6QvkbxOv586FX/lmbM2xiKB1bsW3sKjhOmV30PQ+pWEM8rs
XXMcgVRe6cWx7Aa0HchDEt0sYNoIzOtGLXVXqr+kHM3/vlixbqelF07MkqOfDEbX
2VO1UKYJjcQ9EXMCAwEAAaNOMEwwEQYKKwYBBAGCxAoDAwQDBQIEMBQGCisGAQQB
gsQKAwcEBgIEALeG1jAQBgorBgEEAYLECgMIBAIDATAPBgorBgEEAYLECgMJBAEB
MA0GCSqGSIb3DQEBCwUAA4IBAQAq9O6H02KRvSmBYsz23r6cNTNS/fr5lSPYMHz/
fX+D5B1thKKGstsfZVzoopwIjj86cIWpCYuNfEje+a5HrELL8ClV88JutJR2Nihs
NxU3BbsSUqnwi2rQHcmtHJcC8rjfDzpYDlW1yR+SxVenbVxuRy0v8sbleHSPYaXG
EhjupEAuhq7n0TjZMF1X7KElx9FZZM9HeuxUJvzV7XWiUgA4Zm05+4/zKW01n2kt
+aMaQk7T1oiE0oOK51wJX6J80GzF51pM00oPlh4iDvnnNXYN2KvkNuNwPoceDDE/
8K23ZfJyTN5nibk13UbxEWSHMUue1zcnFp0KdhqxbJYSS/9q
-----END CERTIFICATE-----
~
~ Thanks, now please paste the PIV key certificate of your generated key in PEM format.
~ This snippet should also start with &#39;-----BEGIN CERTIFICATE-----&#39; and end with &#39;-----END CERTIFICATE-----&#39;:
~
-----BEGIN CERTIFICATE-----
MIIC5jCCAc6gAwIBAgIJAKT/dqaxohbiMA0GCSqGSIb3DQEBCwUAMCsxKTAnBgNV
BAMMIFl1YmljbyBQSVYgUm9vdCBDQSBTZXJpYWwgMjYzNzUxMCAXDTE2MDMxNDAw
MDAwMFoYDzIwNTIwNDE3MDAwMDAwWjAhMR8wHQYDVQQDDBZZdWJpY28gUElWIEF0
dGVzdGF0aW9uMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwDhP3YUI
yLWSjseIKNzMscqCdicslrdkxPgMoK8Ocxu0err4yvFXiSZZL32BTZYLD8N7Y+d1
cww6VVsFYdwn01Kc6YLrwM5FIN/msXkGTPdPVhVeqNMHh4QyYrYixwWaTbDCGoQD
axVlifVmPS02Mvm8NDjC17X3LhsV1OiS/wOScsI8HHGgQXQIQEDMnt6cwZ83QK73
7Wuu5uhSzT3jVOz28Rnij1p/8PcVWcGKWCPVYNbCmCdcm/sQeJB8y5aERDaePIIZ
v9axnDT0DnUO7aDpzXA7i7XPbrkiSBEp7RCqXGs5cBqGCbq//xGh+/AGtCCV/sQM
nTjl0d2k2Q8XTwIDAQABoxUwEzARBgorBgEEAYLECgMDBAMFAgQwDQYJKoZIhvcN
AQELBQADggEBAHCnp3k5kQaBwYmR9nUHKGY1dgCvhJUlX2SAyY2fUeaMuURcRRlW
BFw6CvLAjvSs5Dy3O6JWDmk+1WFZo0UMr15WZFiS5Fpy0M+GWvBCRP3YmbSw+J2t
kyWypCIIu7cMtLpRYkL5SAlWmUCAz8dZPk5FLPpeqmxgQnRoSSe67IXiv3bNyPA1
3NoXI2xw0hWQU1+85tfTxoTxOiAzY8UpAT2GggtSmCwO3sHsHJUYXRyCf8e6jtJL
OFBx/uz+VJoRH7hUVOY+sbP5JJ83dRrWZkS57Hf3q0LOtbn27vM+fmL0y7z4vgDo
DedmrmsbPtsRc3t7RWoqCa80Iq1jPvdm5gw=
-----END CERTIFICATE-----
~
~ Public key successfully added:
~ info: ADDED_BY=jdoe USING=selfAddIngressKey UNIQID=2993de2bb014 TIMESTAMP=1609427402 DATETIME=2020-12-31T15:10:02 VERSION=3.01.03
~ PIV: TouchPolicy=Never, PinPolicy=Always, SerialNo=12345678, Firmware=5.2.4
~ fingerprint: SHA256:8B0T6174KUPL1iTSyC0UpnDOvuaCgyKpu8zo9rb2lco (RSA-2048) [2020/12/17]
---------------------------------------------------------&lt;/selfAddIngressKey&gt;---
</pre></div>
</div>
<p>As you can see, we added the public key as usual but were also asked for the two certificates. On the bastion answer, right before the fingerprint of the key, we have a line starting with <em>PIV:</em>, with some metadata extracted from the certificate.</p>
</div>
<div class="section" id="per-account-policy">
<h2><a class="toc-backref" href="#id4">Per-account policy</a><a class="headerlink" href="#per-account-policy" title="Permalink to this headline">¶</a></h2>
<p>If you want to force several accounts to only use certified PIV keys, you can set the option per-account using the <a class="reference internal" href="../plugins/restricted/accountPIV.html"><span class="doc">accountPIV</span></a> command, see its documentation page for all the possible options. The main takeaways are:</p>
<ul class="simple">
<li>If you want an account to only have PIV keys, set the <code class="docutils literal"><span class="pre">enforce</span></code> policy for this account</li>
<li>If you want an account to never require PIV keys, even if the global policy would require it, set the <code class="docutils literal"><span class="pre">never</span></code> policy (useful for accounts used by automated workflows)</li>
</ul>
</div>
<div class="section" id="global-policy">
<h2><a class="toc-backref" href="#id5">Global policy</a><a class="headerlink" href="#global-policy" title="Permalink to this headline">¶</a></h2>
<p>If you want to apply a policy bastion-wide, please refer to the <span class="xref std std-ref">ingressRequiresPIV</span> option. This policy can still be overriden per-account if needed, see above.</p>
</div>
<div class="section" id="temporary-grace-period">
<h2><a class="toc-backref" href="#id6">Temporary grace period</a><a class="headerlink" href="#temporary-grace-period" title="Permalink to this headline">¶</a></h2>
<p>If you enable the PIV policy globally or on several accounts, you'll soon find out that sometimes people forget or lose their PIV-enabled hardware tokens, effectively locking them out of the bastion. There is a <em>temporary grace period</em> feature you can use to handle such cases nicely:</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>$ bssh --osh accountPIV --account lechuck --policy grace --ttl 48h
---the-bastion.example.org--------------------------------the-bastion-3.01.03---
=&gt; modify the PIV policy of an account
--------------------------------------------------------------------------------
~ Changing account configuration...

~ PIV grace up to 2d+00:00:00 (Wed 2021-01-13 09:22:29 UTC) has been set for this account
~ Applying change to keys...

~ Non-PIV account&#39;s ingress keys, if any, have been restored
----------------------------------------------------------------&lt;/accountPIV&gt;---
</pre></div>
</div>
<p>What happens here is that, for a duration of 48 hours, this account will behave as if no PIV policy was enforced: non-PIV keys are allowed again. If this account had non-PIV keys before its policy was set to enforce, those keys are even restored (can be viewed using <a class="reference internal" href="../plugins/open/selfListIngressKeys.html"><span class="doc">selfListIngressKeys</span></a> as usual), so that they can easily connect again. However, after the grace period expires, their policy will go back to what it was previously, and all the non-PIV keys will be disabled again. This event is logged, so you can easily link this event from your SIEM to a potential ticket to your Helpdesk for a hardware key replacement, or such.</p>
<p>This mechanism allows some flexibility (avoiding sending people back home just because they forgot their hardware key), while still enforcing a high-level security policy with the proper processes in place.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../administration/index.html" class="btn btn-neutral float-right" title="Administration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="basics.html" class="btn btn-neutral" title="The basics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, OVHcloud.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'3.01.99-rc2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>